<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StereoGen AI - Textura Pura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0f0f11;
            color: #e5e5e5;
        }
        canvas {
            image-rendering: auto; /* Melhor para fotos/texturas */
        }
        .glass-panel {
            background-color: #1e1e24;
            border: 1px solid #333;
            border-radius: 0.75rem;
        }
        input[type="range"] {
            accent-color: #8b5cf6;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f0f11; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
        
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
        }
        
        :fullscreen { background-color: black; display: flex; align-items: center; justify-content: center; }
        
        /* Temas Dinâmicos */
        .theme-depth .accent-text { color: #a855f7; } 
        .theme-depth .accent-bg { background-color: #9333ea; } 
        .theme-texture .accent-text { color: #ec4899; } 
        .theme-texture .accent-bg { background-color: #db2777; } 
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-[#1e1e24] p-3 md:p-4 flex justify-between items-center z-40 shadow-lg h-[70px] shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-purple-600 to-pink-600 p-2 rounded-lg shadow-lg shadow-purple-900/20">
                <i data-lucide="eye" class="text-white w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-500 leading-none mb-0.5">
                    StereoGen AI
                </h1>
                <p class="text-[10px] text-gray-500 uppercase tracking-widest font-semibold">Gerador de Estereogramas</p>
            </div>
        </div>
        <button onclick="openSettings()" class="group p-2 hover:bg-gray-800 rounded-full transition border border-transparent hover:border-gray-700" title="Configurar API Gemini">
            <i data-lucide="settings" class="w-5 h-5 text-gray-400 group-hover:text-purple-400 transition-colors"></i>
        </button>
    </nav>

    <main class="flex-grow p-4 md:p-6 max-w-[1920px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-70px)]">
        
        <!-- SIDEBAR -->
        <div class="lg:col-span-3 space-y-4 flex flex-col h-full overflow-y-auto pr-2 custom-scrollbar pb-20">
            
            <!-- 1. DIMENSÕES -->
            <div class="glass-panel p-4 space-y-3 shrink-0">
                 <h2 class="text-xs font-bold text-gray-500 uppercase tracking-wider flex items-center gap-2 mb-2">
                    <i data-lucide="monitor" class="w-3 h-3"></i> Formato de Saída
                </h2>
                <div>
                    <select id="aspectRatioSelect" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-2.5 text-sm text-white focus:border-purple-500 focus:outline-none cursor-pointer transition hover:border-gray-600">
                        <option value="16:9">16:9 (Widescreen)</option>
                        <option value="4:3">4:3 (Padrão)</option>
                        <option value="1:1">1:1 (Quadrado)</option>
                        <option value="9:16">9:16 (Stories)</option>
                        <option value="21:9">21:9 (Ultrawide)</option>
                        <option value="original">Igual ao Mapa Original</option>
                    </select>
                </div>
            </div>

            <!-- 2. MAPA -->
            <div class="glass-panel p-4 relative group hover:border-purple-900/50 transition duration-500 shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xs font-bold text-purple-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="layers" class="w-3 h-3"></i> Mapa de Profundidade
                    </h2>
                    <button onclick="openGenerator('depth')" class="text-[10px] bg-purple-600/20 hover:bg-purple-600 text-purple-300 hover:text-white px-2 py-1 rounded border border-purple-600/50 transition flex items-center gap-1 shadow-sm">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> IA
                    </button>
                </div>
                
                <div class="bg-black/50 rounded-lg p-3 border border-gray-800 mb-3 text-center relative overflow-hidden h-32 flex items-center justify-center group-hover:border-purple-900/30 transition">
                    <img id="depthPreview" class="w-full h-full object-contain opacity-60" alt="Preview">
                    <div class="absolute bottom-1 right-1 bg-black/80 px-1.5 rounded text-[9px] text-gray-400 font-mono" id="depthDims">-- x --</div>
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <input type="file" id="depthInput" accept="image/*" class="hidden">
                    <label for="depthInput" class="col-span-2 bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white text-xs py-2 rounded-lg cursor-pointer text-center border border-gray-700 transition flex items-center justify-center gap-2">
                        <i data-lucide="upload" class="w-3 h-3"></i> Carregar Arquivo
                    </label>
                    <button onclick="loadExample('circle')" class="bg-gray-800 hover:bg-gray-700 text-gray-400 text-xs py-1.5 rounded border border-gray-700 transition">Círculo</button>
                    <button onclick="loadExample('text')" class="bg-gray-800 hover:bg-gray-700 text-gray-400 text-xs py-1.5 rounded border border-gray-700 transition">Texto</button>
                </div>
            </div>

            <!-- 3. TEXTURA -->
            <div class="glass-panel p-4 relative group hover:border-pink-900/50 transition duration-500 shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-xs font-bold text-pink-400 uppercase tracking-wider flex items-center gap-2">
                        <i data-lucide="image" class="w-3 h-3"></i> Textura (Padrão)
                    </h2>
                    <button onclick="openGenerator('texture')" class="text-[10px] bg-pink-600/20 hover:bg-pink-600 text-pink-300 hover:text-white px-2 py-1 rounded border border-pink-600/50 transition flex items-center gap-1 shadow-sm">
                        <i data-lucide="sparkles" class="w-3 h-3"></i> IA
                    </button>
                </div>

                <div class="bg-black/50 rounded-lg p-3 border border-gray-800 mb-3 text-center relative overflow-hidden h-24 flex items-center justify-center group-hover:border-pink-900/30 transition">
                    <img id="patternPreview" class="w-full h-full object-cover hidden rounded" alt="Preview">
                    <div id="patternPlaceholder" class="text-center">
                        <i data-lucide="palette" class="w-6 h-6 mx-auto text-gray-700 mb-1"></i>
                        <span class="text-[10px] text-gray-600">Sem textura (Ruído auto)</span>
                    </div>
                    <button onclick="removeTexture()" id="removeTextureBtn" class="hidden absolute top-1 right-1 bg-red-900/80 hover:bg-red-700 text-white p-1 rounded-full shadow-lg" title="Remover"><i data-lucide="x" class="w-3 h-3"></i></button>
                </div>

                <input type="file" id="patternInput" accept="image/*" class="hidden">
                <label for="patternInput" class="w-full block bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-white text-xs py-2 rounded-lg cursor-pointer text-center border border-gray-700 transition flex items-center justify-center gap-2">
                    <i data-lucide="upload" class="w-3 h-3"></i> Carregar Textura
                </label>
            </div>

            <!-- 4. AJUSTES -->
            <div class="glass-panel p-4 space-y-4 shrink-0">
                <h2 class="text-xs font-bold text-blue-400 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="sliders" class="w-3 h-3"></i> Configurações
                </h2>

                <div class="space-y-3">
                    <div>
                        <div class="flex justify-between text-[10px] uppercase text-gray-500 mb-1 font-bold">
                            <span>Profundidade (3D)</span>
                            <span id="depthValDisplay" class="text-white font-mono bg-gray-800 px-1 rounded">20</span>
                        </div>
                        <input type="range" id="depthFactor" min="5" max="80" value="20" class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div>
                        <div class="flex justify-between text-[10px] uppercase text-gray-500 mb-1 font-bold">
                            <span>Largura Padrão</span>
                            <span id="patValDisplay" class="text-white font-mono bg-gray-800 px-1 rounded">140px</span>
                        </div>
                        <input type="range" id="patternWidth" min="80" max="300" value="140" class="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>
                </div>

                <div class="bg-gray-900/50 rounded p-2 space-y-2 border border-gray-800">
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="addGuides" class="peer sr-only">
                            <div class="w-8 h-4 bg-gray-700 rounded-full peer-checked:bg-purple-600 transition"></div>
                            <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition transform peer-checked:translate-x-4"></div>
                        </div>
                        <span class="text-xs text-gray-400 group-hover:text-gray-300">Mostrar Guias</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer group">
                        <div class="relative flex items-center">
                            <input type="checkbox" id="invertDepth" class="peer sr-only">
                            <div class="w-8 h-4 bg-gray-700 rounded-full peer-checked:bg-purple-600 transition"></div>
                            <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-white rounded-full transition transform peer-checked:translate-x-4"></div>
                        </div>
                        <span class="text-xs text-gray-400 group-hover:text-gray-300">Inverter (Preto=Perto)</span>
                    </label>
                </div>

                <button onclick="generateStereogram()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold py-3 rounded-lg shadow-lg shadow-purple-900/20 transform active:scale-95 transition-all flex items-center justify-center gap-2">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> ATUALIZAR
                </button>
            </div>
        </div>

        <!-- MAIN: Resultado -->
        <div class="lg:col-span-9 flex flex-col h-full overflow-hidden">
            <div class="glass-panel p-0 flex-grow flex flex-col relative overflow-hidden bg-[#050505] group shadow-2xl h-full w-full">
                
                <!-- Toolbar Flutuante -->
                <div class="absolute top-4 right-4 flex gap-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    <button onclick="toggleFullScreen()" class="bg-black/60 hover:bg-black/90 text-white p-2.5 rounded-lg backdrop-blur-md border border-white/10 transition" title="Tela Cheia">
                        <i data-lucide="maximize" class="w-5 h-5"></i>
                    </button>
                    <button onclick="downloadImage()" class="bg-purple-600/90 hover:bg-purple-500 text-white p-2.5 rounded-lg backdrop-blur-md border border-white/10 shadow-lg shadow-purple-900/20 transition" title="Salvar Imagem">
                        <i data-lucide="download" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Canvas Wrapper -->
                <!-- Centralizado com Flexbox, ocupando todo o espaço possível -->
                <div id="canvasContainer" class="w-full h-full flex items-center justify-center bg-[#020202] p-2 relative">
                    <canvas id="resultCanvas" class="shadow-2xl border border-gray-800 block"></canvas>
                </div>
                
                <div class="absolute bottom-4 left-0 w-full text-center pointer-events-none opacity-50">
                    <p class="text-[10px] text-gray-500 uppercase tracking-[0.2em]">Resultado Gerado</p>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL SETTINGS -->
    <div id="settingsModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 shadow-2xl bg-[#1e1e24] border border-gray-700 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i data-lucide="key" class="w-5 h-5 text-yellow-500"></i> Configuração Gemini API
                </h3>
                <button onclick="closeSettings()" class="text-gray-500 hover:text-white transition"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API Key</label>
                    <div class="relative">
                        <input type="password" id="apiKeyInput" class="w-full bg-gray-950 border border-gray-700 rounded p-3 text-white text-sm focus:border-purple-500 focus:outline-none pr-10 font-mono" placeholder="AIzaSy...">
                        <button onclick="toggleKeyVisibility()" class="absolute right-3 top-3 text-gray-500 hover:text-white">
                            <i id="eyeIcon" data-lucide="eye" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>

                <div class="bg-blue-900/20 p-3 rounded border border-blue-900/50 flex items-start gap-3">
                    <i data-lucide="info" class="w-5 h-5 text-blue-400 flex-shrink-0 mt-0.5"></i>
                    <div class="text-xs text-blue-200/70 leading-relaxed">
                        A chave é salva apenas no seu navegador. Necessária para usar a IA.
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 underline hover:text-blue-300 ml-1">Obter chave grátis</a>
                    </div>
                </div>

                <button onclick="saveSettings()" class="w-full bg-gray-100 hover:bg-white text-gray-900 py-2.5 rounded font-bold text-sm transition mt-2">
                    Salvar Chave
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL GEN -->
    <div id="genModal" class="fixed inset-0 modal-backdrop z-50 hidden flex items-center justify-center p-4">
        <div id="genModalContainer" class="glass-panel w-full max-w-lg p-0 shadow-2xl bg-[#1e1e24] border border-gray-700 overflow-hidden flex flex-col max-h-[90vh] transition-colors duration-300">
            
            <div class="p-5 border-b border-gray-800 bg-gray-900/50 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <i id="genIcon" data-lucide="bot" class="w-5 h-5"></i>
                    <span id="genTitle">Gerar com IA</span>
                </h3>
                <button onclick="closeGenerator()" class="text-gray-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <div class="p-6 space-y-5 overflow-y-auto">
                <div class="flex items-center gap-2 text-xs text-gray-400 bg-gray-800/50 p-2 rounded border border-gray-700">
                    <i data-lucide="monitor" class="w-3 h-3"></i>
                    <span>Formato selecionado: <strong id="genAspectRatioDisplay" class="text-white">16:9</strong></span>
                </div>

                <div>
                    <label id="genLabel" class="block text-xs font-bold text-gray-500 uppercase mb-2">Descreva sua ideia</label>
                    <div class="relative">
                        <textarea id="genPrompt" rows="3" class="w-full bg-gray-950 border border-gray-700 rounded-lg p-3 text-white focus:outline-none resize-none text-sm leading-relaxed" placeholder="Ex: Um crânio detalhado, uma floresta densa..."></textarea>
                        <i data-lucide="sparkles" class="accent-text absolute right-3 bottom-3 w-4 h-4 opacity-50"></i>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-gray-600 uppercase mb-2">Sugestões Rápidas</label>
                    <div class="flex flex-wrap gap-2" id="presetContainer"></div>
                </div>

                <div class="bg-black/30 p-3 rounded border border-gray-800">
                    <div class="flex items-center gap-2 mb-1">
                        <i data-lucide="terminal" class="w-3 h-3 text-gray-500"></i>
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Prompt Técnico Gerado</span>
                    </div>
                    <p id="finalPromptPreview" class="text-xs text-gray-400 font-mono break-words leading-relaxed opacity-80">...</p>
                </div>

                <div id="genLoading" class="hidden">
                    <div class="flex items-center justify-center gap-3 py-2 text-white bg-gray-800/50 rounded border border-gray-700/50">
                        <div class="accent-border animate-spin rounded-full h-4 w-4 border-2 border-t-transparent"></div>
                        <span class="text-xs font-bold uppercase tracking-wide">Criando Imagem...</span>
                    </div>
                </div>

                <button onclick="executeGeneration()" id="genActionBtn" class="accent-bg w-full text-white font-bold py-3.5 rounded-lg shadow-lg transition flex items-center justify-center gap-2 group hover:opacity-90">
                    <i data-lucide="zap" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> GERAR IMAGEM
                </button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- ESTADO GLOBAL ---
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        const depthPreview = document.getElementById('depthPreview');
        const patternPreview = document.getElementById('patternPreview');
        const aspectRatioSelect = document.getElementById('aspectRatioSelect');
        const canvasContainer = document.getElementById('canvasContainer');
        
        let loadedDepthImg = null;
        let loadedPatternImg = null;
        let currentGenType = 'depth'; 

        // ESTADO PROMPTS
        let depthPromptState = "";
        let texturePromptState = "";

        // --- INICIALIZAÇÃO ---
        window.onload = () => {
            loadExample('circle');
            setupEvents();
            checkApiKey();
        };

        function setupEvents() {
            ['depthFactor', 'patternWidth'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const displayId = id === 'depthFactor' ? 'depthValDisplay' : 'patValDisplay';
                    document.getElementById(displayId).innerText = e.target.value + (id === 'depthFactor' ? '' : 'px');
                    if(loadedDepthImg) requestAnimationFrame(generateStereogram);
                });
            });

            document.getElementById('depthInput').addEventListener('change', (e) => handleUpload(e, 'depth'));
            document.getElementById('patternInput').addEventListener('change', (e) => handleUpload(e, 'pattern'));
            document.getElementById('aspectRatioSelect').addEventListener('change', generateStereogram);
            document.getElementById('addGuides').addEventListener('change', generateStereogram);
            document.getElementById('invertDepth').addEventListener('change', generateStereogram);

            document.getElementById('genPrompt').addEventListener('input', (e) => {
                if(currentGenType === 'depth') {
                    depthPromptState = e.target.value;
                } else {
                    texturePromptState = e.target.value;
                }
                updatePromptPreview();
            });
        }

        // --- SISTEMA DE ARQUIVOS ---
        function handleUpload(e, type) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                const img = new Image();
                img.onload = () => {
                    if (type === 'depth') {
                        loadedDepthImg = img;
                        depthPreview.src = img.src;
                        document.getElementById('depthDims').innerText = `${img.width}x${img.height}`;
                    } else {
                        loadedPatternImg = img;
                        patternPreview.src = img.src;
                        patternPreview.classList.remove('hidden');
                        document.getElementById('patternPlaceholder').classList.add('hidden');
                        document.getElementById('removeTextureBtn').classList.remove('hidden');
                    }
                    generateStereogram();
                };
                img.src = evt.target.result;
            };
            reader.readAsDataURL(file);
        }

        function loadExample(type) {
            const tCanvas = document.createElement('canvas');
            const tCtx = tCanvas.getContext('2d');
            const w = 1280;
            const h = 720;
            tCanvas.width = w;
            tCanvas.height = h;

            tCtx.fillStyle = '#000';
            tCtx.fillRect(0,0,w,h);
            tCtx.fillStyle = '#FFF';

            if (type === 'circle') {
                const grad = tCtx.createRadialGradient(w/2, h/2, 50, w/2, h/2, 300);
                grad.addColorStop(0, '#FFF');
                grad.addColorStop(1, '#000');
                tCtx.fillStyle = grad;
                tCtx.beginPath(); tCtx.arc(w/2, h/2, 300, 0, Math.PI*2); tCtx.fill();
            } else {
                tCtx.font = 'bold 300px sans-serif';
                tCtx.textAlign = 'center'; tCtx.textBaseline = 'middle';
                tCtx.fillText('3D', w/2, h/2);
                tCtx.filter = 'blur(10px)';
                tCtx.fillText('3D', w/2, h/2);
            }

            loadedDepthImg = new Image();
            loadedDepthImg.onload = () => {
                depthPreview.src = loadedDepthImg.src;
                document.getElementById('depthDims').innerText = `${w}x${h}`;
                generateStereogram();
            };
            loadedDepthImg.src = tCanvas.toDataURL();
        }

        function removeTexture() {
            loadedPatternImg = null;
            document.getElementById('patternInput').value = '';
            patternPreview.src = '';
            patternPreview.classList.add('hidden');
            document.getElementById('patternPlaceholder').classList.remove('hidden');
            document.getElementById('removeTextureBtn').classList.add('hidden');
            generateStereogram();
        }

        // --- CORE LOGIC: ESTEREOGRAMA (FIXED TEXTURE) ---
        function generateStereogram() {
            if (!loadedDepthImg) return;

            const separation = parseInt(document.getElementById('patternWidth').value);
            const depthFactor = parseInt(document.getElementById('depthFactor').value);
            const userInvert = document.getElementById('invertDepth').checked; 
            const showGuides = document.getElementById('addGuides').checked;
            const aspectMode = aspectRatioSelect.value;

            // 1. DIMENSÕES
            let targetW, targetH;
            const BASE_WIDTH = 1280; 

            if (aspectMode === 'original') {
                const ratio = loadedDepthImg.width / loadedDepthImg.height;
                targetW = BASE_WIDTH;
                targetH = Math.round(targetW / ratio);
            } else {
                const [rw, rh] = aspectMode.split(':').map(Number);
                const targetRatio = rw / rh;
                targetW = BASE_WIDTH;
                targetH = Math.round(targetW / targetRatio);
            }

            canvas.width = targetW;
            const yOffset = showGuides ? 50 : 0;
            canvas.height = targetH + yOffset;

            // Ajuste visual CSS para o canvas caber bem na tela
            // Garantir que a proporção visual do elemento HTML corresponda ao escolhido
            canvas.style.maxWidth = "100%";
            canvas.style.maxHeight = "100%";
            canvas.style.aspectRatio = `${targetW}/${targetH + yOffset}`;


            // 2. DEPTH MAP (Esticado/Cover para preencher a área)
            const dCtx = document.createElement('canvas').getContext('2d');
            dCtx.canvas.width = targetW;
            dCtx.canvas.height = targetH;
            dCtx.drawImage(loadedDepthImg, 0, 0, targetW, targetH);
            const depthData = dCtx.getImageData(0,0,targetW,targetH).data;

            // 3. TEXTURA / PATTERN STRIP (CORRIGIDO: TILING/REPETIÇÃO)
            let pCtx = document.createElement('canvas').getContext('2d');
            pCtx.canvas.width = separation;
            pCtx.canvas.height = targetH;

            if (loadedPatternImg) {
                // CORREÇÃO CRÍTICA:
                // Em vez de 'drawImage' com width=separation (que espreme a imagem),
                // usamos 'createPattern' para repetir a imagem no tamanho original.
                // Isso preserva a qualidade dos pixels (rochas, olhos, texturas).
                
                const ptrn = pCtx.createPattern(loadedPatternImg, 'repeat');
                pCtx.fillStyle = ptrn;
                pCtx.fillRect(0, 0, separation, targetH);
            } else {
                // Fallback: Ruído
                const pData = pCtx.createImageData(separation, targetH);
                for (let i = 0; i < pData.data.length; i += 4) {
                    pData.data[i] = Math.random() * 255;    
                    pData.data[i+1] = Math.random() * 255;   
                    pData.data[i+2] = Math.random() * 255;   
                    pData.data[i+3] = 255;                   
                }
                pCtx.putImageData(pData, 0, 0);
            }
            
            const patternData = pCtx.getImageData(0,0,separation,targetH).data;
            
            // 4. ALGORITMO SIS
            const finalImgData = ctx.createImageData(targetW, targetH);
            const data = finalImgData.data;

            for (let y = 0; y < targetH; y++) {
                for (let x = 0; x < targetW; x++) {
                    let sourceIndex = -1;

                    if (x < separation) {
                        sourceIndex = x; 
                    } else {
                        let depthVal = depthData[(y * targetW + x) * 4]; 
                        if (userInvert) depthVal = 255 - depthVal;
                        const z = depthVal / 255;
                        const shift = Math.floor(z * depthFactor);
                        sourceIndex = x - separation + shift;
                    }

                    let r, g, b;
                    if (sourceIndex < separation) {
                        if (sourceIndex < 0) sourceIndex = 0; 
                        // Pegar do Pattern Strip (que agora é a textura repetida limpa)
                        const pIdx = (y * separation + sourceIndex) * 4;
                        r = patternData[pIdx];
                        g = patternData[pIdx+1];
                        b = patternData[pIdx+2];
                    } else {
                        const prevIdx = (y * targetW + sourceIndex) * 4;
                        r = data[prevIdx];
                        g = data[prevIdx+1];
                        b = data[prevIdx+2];
                    }

                    const idx = (y * targetW + x) * 4;
                    data[idx] = r;
                    data[idx+1] = g;
                    data[idx+2] = b;
                    data[idx+3] = 255;
                }
            }

            ctx.putImageData(finalImgData, 0, yOffset);

            if (showGuides) {
                ctx.fillStyle = "#111";
                ctx.fillRect(0, 0, targetW, 50);
                
                const centerX = targetW / 2;
                const halfSep = separation / 2;
                
                ctx.fillStyle = "#ef4444"; 
                ctx.beginPath(); ctx.arc(centerX - halfSep, 25, 6, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(centerX + halfSep, 25, 6, 0, Math.PI*2); ctx.fill();

                ctx.fillStyle = "#666";
                ctx.font = "12px sans-serif";
                ctx.textAlign = "center";
                ctx.fillText("Cruze ou afaste a visão até unir os pontos", centerX, 45);
            }
        }

        // --- INTEGRAÇÃO API ---
        function checkApiKey() {
            const key = localStorage.getItem('gemini_api_key');
        }

        function openSettings() {
            document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || '';
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        
        function saveSettings() {
            const k = document.getElementById('apiKeyInput').value.trim();
            if(k) localStorage.setItem('gemini_api_key', k);
            closeSettings();
        }

        function toggleKeyVisibility() {
            const inp = document.getElementById('apiKeyInput');
            inp.type = inp.type === 'password' ? 'text' : 'password';
        }

        // --- GERADOR IA ---
        function openGenerator(type) {
            if(!localStorage.getItem('gemini_api_key')) {
                openSettings(); return;
            }
            
            currentGenType = type;
            const container = document.getElementById('genModalContainer');
            const ar = document.getElementById('aspectRatioSelect').value;
            document.getElementById('genAspectRatioDisplay').innerText = ar === 'original' ? '1:1 (Padrão)' : ar;
            
            if (type === 'depth') {
                container.classList.remove('theme-texture');
                container.classList.add('theme-depth');
                document.getElementById('genTitle').innerText = 'Gerar Mapa de Profundidade';
                document.getElementById('genLabel').innerText = 'Descreva o Objeto 3D';
                document.getElementById('genIcon').setAttribute('class', 'w-5 h-5 text-purple-400');
                document.getElementById('genPrompt').value = depthPromptState;
            } else {
                container.classList.remove('theme-depth');
                container.classList.add('theme-texture');
                document.getElementById('genTitle').innerText = 'Gerar Textura (Padrão)';
                document.getElementById('genLabel').innerText = 'Descreva o Padrão';
                document.getElementById('genIcon').setAttribute('class', 'w-5 h-5 text-pink-400');
                document.getElementById('genPrompt').value = texturePromptState;
            }

            document.getElementById('genModal').classList.remove('hidden');
            
            const pContainer = document.getElementById('presetContainer');
            pContainer.innerHTML = '';
            
            const presets = type === 'depth' 
                ? ['Caveira', 'Dragão', 'Avião Caça', 'Planeta Saturno', 'Coração Geométrico', 'Mão Humana'] 
                : ['Folhas Outono', 'Pedras Rio', 'Tecido Abstrato', 'Matrix Code', 'Doces Coloridos', 'Fogo Intenso'];
            
            presets.forEach(p => {
                const b = document.createElement('button');
                b.className = "bg-gray-800 hover:bg-gray-700 text-[10px] text-gray-300 px-3 py-1.5 rounded-full border border-gray-700 transition";
                b.innerText = p;
                b.onclick = () => {
                    document.getElementById('genPrompt').value = p;
                    if (type === 'depth') depthPromptState = p;
                    else texturePromptState = p;
                    updatePromptPreview();
                };
                pContainer.appendChild(b);
            });
            updatePromptPreview();
        }

        function closeGenerator() { 
            document.getElementById('genModal').classList.add('hidden'); 
            document.getElementById('genLoading').classList.add('hidden'); 
        }

        function updatePromptPreview() {
            const val = document.getElementById('genPrompt').value;
            const ar = document.getElementById('aspectRatioSelect').value;
            const arText = ar === 'original' ? '' : `, aspect ratio ${ar}`; 
            
            let final = "";
            if (currentGenType === 'depth') {
                final = `High contrast depth map of ${val || 'OBJECT'}, grayscale, white is near, black is far background, smooth gradients, centered composition, 3d render style, 8k resolution${arText}`;
            } else {
                final = `Seamless texture pattern of ${val || 'THEME'}, wallpaper style, repeating pattern, high detail, vibrant colors, no depth blur, flat lighting, 4k${arText}`;
            }
            document.getElementById('finalPromptPreview').innerText = final;
        }

        async function executeGeneration() {
            const input = document.getElementById('genPrompt').value;
            if(!input) return;

            const apiKey = localStorage.getItem('gemini_api_key');
            const prompt = document.getElementById('finalPromptPreview').innerText;
            const loading = document.getElementById('genLoading');
            const aspectMode = document.getElementById('aspectRatioSelect').value;
            
            let apiAspectRatio = aspectMode === 'original' ? '1:1' : aspectMode;

            loading.classList.remove('hidden');

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        instances: [{ prompt: prompt }],
                        parameters: { 
                            sampleCount: 1,
                            aspectRatio: apiAspectRatio 
                        }
                    })
                });

                const data = await res.json();
                if(data.error) throw new Error(data.error.message);
                
                if(data.predictions && data.predictions[0]) {
                    const url = `data:image/png;base64,${data.predictions[0].bytesBase64Encoded}`;
                    const img = new Image();
                    img.onload = () => {
                        if(currentGenType === 'depth') {
                            loadedDepthImg = img;
                            depthPreview.src = url;
                            document.getElementById('depthDims').innerText = `${img.width}x${img.height}`;
                        } else {
                            loadedPatternImg = img;
                            patternPreview.src = url;
                            patternPreview.classList.remove('hidden');
                            document.getElementById('patternPlaceholder').classList.add('hidden');
                            document.getElementById('removeTextureBtn').classList.remove('hidden');
                        }
                        generateStereogram();
                        closeGenerator();
                    };
                    img.src = url;
                }
            } catch(e) {
                alert("Erro: " + e.message);
            } finally {
                loading.classList.add('hidden');
            }
        }

        function toggleFullScreen() {
            const el = document.getElementById('canvasContainer');
            if(!document.fullscreenElement) el.requestFullscreen();
            else document.exitFullscreen();
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `stereogen_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        }
    </script>
</body>
</html>


